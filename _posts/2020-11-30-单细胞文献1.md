---
layout:     post
title:      2020-11-30-单细胞文献阅读系列一
subtitle:   单细胞RNA-seq数据分析最佳实践（上）
date:       2020-11-30
author:     DL
header-img: img/home-bg-o.jpg
catalog: true
tags:
    - 单细胞测序
---

> 来源：[单细胞天地](https://mp.weixin.qq.com/s/S83Zh_FiEHaibe0yaq6y7Q)

> 文章信息：Luecken MD, Theis FJ. Current best practices in single-cell RNA-seq analysis: a tutorial. Mol. Syst. Biol. 2019, 15: e8746.

[![Dgbhng.jpg](https://s3.ax1x.com/2020/11/30/Dgbhng.jpg)](https://imgchr.com/i/Dgbhng)

---

## 一、摘要

&emsp;&emsp;single cell RNA-seq 提高了基因表达研究的分辨率，这项技术也带来越来越多的单细胞分析方法。这使得研究者难以驾驭这一多工具格局并从中搭建最新的工作流程来分析自己的数据。在这里，我们详细介绍了典型的单细胞 RNA-seq 数据分析步骤，包括预处理（质量控制、标准化、数据校正、特征选择和降维）以及细胞及基因水平的下游分析。我们根据独立比较研究为这些步骤制定了当前（2019年）最佳实践建议。我们已将这些最佳实践建议整合到工作流中，并将其应用于公共数据集，以进一步说明这些步骤在实践中如何工作。我们的案例研究可参见https://www.github.com/theislab/single-cell-tutorial。这篇综述将作为单细胞新手进入该领域的数据分析流程指南，并帮助现有的研究人员更新他们的分析流程。

> 关键词:分析流程开发；计算生物学；数据分析教程；单细胞 RNA-seq

---

## 二、前言

&emsp;&emsp;近年来，单细胞 RNA 测序 (scRNA-seq) 推进了我们对生物系统的认识。我们已经能够研究斑马鱼、青蛙和涡虫的细胞异质性 (Briggs et al,2018；Plass et al,2018；Wagner et al,2018)，并发现之前被掩盖的细胞群 (Montoro et al,2018；Plasschaert et al,2018)。该技术的巨大潜力促使计算生物学家开发一系列分析工具 (Rostom et al,2017)。尽管该领域正在努力确保单个工具的可用性，但单细胞数据分析中，新手的一个进入障碍（ a barrier of entry）是由于该领域相对不成熟而缺乏标准。在本文中，我们简述目前scRNA-seq 分析的最佳做法，为今后的分析标准化奠定基础。

&emsp;&emsp;标准化面临的挑战包括分析方法不断增加（截至 2019 年 3 月 7 日已达 385多种工具）和数据集规模爆炸性增长 (Angerer et al,2017；Zappia et al,2018)。我们正在不断寻找新的方法来使用我们所测得的数据。例如，最近的工具可预测分化中的细胞命运 (La Manno et al,2018)。分析工具的不断改进有利于产生新的科学洞察力，但这也使标准化更加复杂。

&emsp;&emsp;标准化的第二个挑战在于技术方面。scRNA-seq 数据的分析工具用各种编程语言，最突出的是 R 和 Python (Zappia et al,2018)。尽管跨环境的工具正在增长（预印：Scholz et al,2018），但编程语言的选择通常也是分析工具之间的一种选择。Seurat (Butler et al,2018)、Scater (McCarthy et al,2017) 或 Scanpy (Wolf et al,2018) 等热门平台提供了开发流程的集成环境，且包含大型分析工具。然而，这些平台仅限于使用各自编程语言开发的工具。通过扩展，语言限制也适用于目前可用的 scRNA-seq 分析教程，其中许多教程围绕上述平台（R 和 bioconductor 工具：https://github.com/drisso/bioc2016singlecell和https://hemberg-lab.github.io/scRNA.seq）。

&emsp;&emsp;考虑到上述挑战，我们并没有标准化分析流程，而是概述了当前的最佳实践和独立于编程语言的通用工具。我们指导读者完成 scRNA-seq 分析流程的各个步骤（图 1），介绍当前的最佳实践，并讨论分析陷阱提出开放性问题。由于工具的新颖性和缺乏比较，事实上无法确定最佳实践，因此我们列出了流行的可用工具。所概述的步骤从reads或计数矩阵开始，得出潜在分析终点，Lun et al (2016b) 涵盖了早期预处理步骤。整合现有最佳实践的详细案例研究可从我们的 github 获得，网址为：https://github.com/theislab/single-cell-tutorial/。在这里，我们在一个实际的示例工作流中应用了当前的最佳实践来分析公共数据集。分析工作流程用rpy2在 Jupyter-Ipython notebook中集成了 R 和 Python 工具。有了可用的文档，它很容易作为工作流模板进行二次修改。

[![DgqMCt.jpg](https://s3.ax1x.com/2020/11/30/DgqMCt.jpg)](https://imgchr.com/i/DgqMCt)

>图 1. 典型的单细胞 RNA-seq 分析工作流程示意图。原始测序数据经过处理和比对，得到计数矩阵，代表工作流程的开始。计数矩阵经过预处理和下游分析。使用 Haber et al (2017) 肠上皮细胞数据的最佳实践工作流程生成子图。

---

## 三、实验性scRNA-seq工作流的关键元素

&emsp;&emsp;从生物样本到可分析的单细胞数据需要经过多个步骤。典型的工作流程包括：单细胞解离、单细胞分离、文库构建和测序。对这些阶段的简要概述如下：单细胞实验的起始材料通常以生物组织样本的形式获得。

&emsp;&emsp;单细胞悬浮液的制备作为第一步，是在一个被称为单细胞解离的过程中产生的，其中组织被消化。为分析每个细胞中的 mRNA，必须分离细胞。单细胞分离根据实验方案的不同而不同。虽然基于平板的技术将细胞隔离到平板上的孔中，但基于液滴的方法依赖于在自己的微流体液滴中捕获每个细胞。在这两种情况下，都可能发生错误，导致多个细胞被捕获在一起（doublets or multiplets）、非活细胞被捕获或完全没有细胞被捕获（空液滴/孔）形成空滴的情况尤其常见，因为基于液滴的方法依靠低浓度的输入细胞流动来控制双联体率。每孔或液滴中都含有分解细胞膜和进行文库构建所必需的化学物质。胞内 mRNA 被捕获、反转录为 cDNA 分子并扩增的过程称为文库构建。当细胞隔离进行这一过程时，每个细胞的 mRNA 可以被一个孔或滴特定的细胞条形码标记。此外，许多实验方案也用唯一分子标识符 (UMI) 标记捕获的分子。测序前扩增细胞 cDNA，以增加其被测量的概率。UMIs 允许我们区分相同 mRNA 分子的扩增拷贝和从相同基因转录的不同 mRNA 分子的reads。

&emsp;&emsp;构建好文库后，使用细胞条形码进行标记，并根据协议进行UMIs标记。这些库汇集在一起(multiplexed)用于测序。序列产生reads数据，这些数据经过质量控制，再准备阶段根据指定的条形码(demultiplexing)和reads比对区分细胞。对于基于umi的协议，reads数据可以被进一步解复用以产生捕获的mRNA分子计数(count data)。

---

## 四、Pre-processing and visualization

&emsp;&emsp;对测序仪生成的原始数据进行处理，以获得分子计数（count 矩阵）或读数（reads矩阵）的矩阵，这取决于是否在单细胞文库构建方案中纳入了独特的分子标识符 ( unique molecular
identifiers ，UMI)（有关分析前的实验步骤概述，请参见2.1）。Cell Ranger (Zheng et al,2017)、indrops (Klein et al,2015)、SEQC (Azizi et al,2018) 或 zUMIs (Parekh et al,2018) 等原始数据处理流程负责reads质量控制 (QC)，为其细胞barcode和 mRNA 来源分子（也称为解复用,demultiplexing）分配reads、基因组比对和定量。得到的reads或计数矩阵包含barcode x 转录本数量的高纬数据。此处使用术语barcode代替细胞，因为所有reads均为分配给相同的barcode可能与来自同一细胞的reads不一致。一个barcode可能错误地标记多个细胞（双联体）或可能不标记任何细胞（空滴/孔）。虽然reads和计数数据的测量噪声水平不同，但典型分析流程中的处理步骤相同。为了简单起见，我们将在本教程中将这些数据称为count矩阵。如果reads和count矩阵的结果不同，则专门指出reads矩阵。

---

**预处理划分为 5 个数据处理阶段：**

-  原始数据，
-  标准化数据，
-  校正数据，
-  特征选择数据，
-  降维数据。

这些数据处理阶段分为三个预处理层：

- 测量数据、
- 校正数据和
- 缩减数据（降维）。

具体的scRNAseq 中常见的预处理步骤概述为下面的工作流程：

### 1.Quality control

在分析单细胞基因表达数据之前，我们必须确保所有的细胞barcode数据都对应于活细胞。细胞 QC 通常基于三个 QC 变量进行：

- 每个barcode的计数数量（count depth ）
- 每个barcode的基因数量
- 每个barcode的线粒体基因计数分数 (Ilicic et al,2016；Griffiths et al,2018)

&emsp;&emsp;检查这些 QC 变量的分布，以确定是否存在通过阈值处理过滤掉的离群峰（图 2）。这些异常barcode可能对应于死细胞、膜破损的细胞或双联体。例如，低计数深度的barcode、很少检测到的基因以及线粒体计数的高分数都表明细胞的细胞质 mRNA 已经通过破损的膜漏出，只有位于线粒体中的 mRNA 仍然是保守的（图 2）。与之相反，非预期高计数和大量检测基因的细胞可能代表双联体。因此，高计数深度阈值常用于过滤掉潜在的双峰。最近的三种双联检测工具提供了更优雅和可能更好的解决方案 (DoubletDecon:preprint:DePasquale et al,2018；Scrublet:Wolock et al,2019；doublet Finder:McGinnis et al,2018)。

[![DgOefI.jpg](https://s3.ax1x.com/2020/11/30/DgOefI.jpg)](https://imgchr.com/i/DgOefI)

>图 2. Haber et al (2017) 的小鼠肠上皮数据集过滤决策的质量控制指标图。(A) 每个cell的计数深度直方图。较小的直方图在计数深度低于 4,000 时放大。根据在约 1,200 个计数处检测到的峰值，此处应用的阈值为 1,500。(B) 每个细胞检测到的基因数的直方图。在大约 400 个基因处可见一个小的噪声峰。这些细胞使用描述的阈值（红线）700 个基因过滤掉。计数深度分布从高到低计数深度。该可视化与 Cell Ranger 输出中显示的 logClog 图相关，该输出用于过滤空液滴。它显示了一个肘部的计数深度开始迅速减少约 1500 计数。(D) 通过线粒体读数部分染色的基因数量与计数深度的关系。线粒体读取片段仅在检测基因很少的特别低计数细胞中高。这些细胞被我们的计数和基因数阈值过滤掉。联合可视化计数和基因阈值显示联合过滤效果，表明较低的基因阈值可能已经足够

&emsp;&emsp;单独考虑这三个细胞 QC 变量中的任何一个都可能导致对细胞信号的误解。例如，具有较高线粒体计数的细胞可能参与呼吸过程。同样，其他 QC 变量也有生物学解释。低count和（或）基因的细胞可对应静止细胞群，高count的细胞体积可能更大。事实上，细胞之间的分子计数可能存在强烈差异（参见项目 github 的案例研究）。因此，当单变量阈值决策时，应联合考虑细胞 QC 变量（图 2D），这些阈值应尽可能设置为允许的，以避免无意中过滤掉活细胞群。考虑到多变量细胞 QC 的依赖性，筛选模型可能提供更敏感的 QC 选项。

&emsp;&emsp;含有异质混合细胞类型的数据集可能显示多个 细胞QC 变量峰值。例如，图 2D 显示了具有不同 QC 分布的两个细胞群。如果之前没有进行过滤步骤（注意 Cell Ranger 也进行细胞 QC），那么只有每个barcode峰的最低计数深度和基因应该被认为是非活细胞。进一步的阈值指导原则是使用所选阈值过滤掉的细胞比例。对于高计数过滤，该比例不应超过预期的双联率。

&emsp;&emsp;除了检查细胞的完整性，细胞 QC 步骤也必须在转录本水平上进行。原始计数基质通常超过 20,000 个基因。通过过滤掉在少数细胞中不表达的基因，可以大幅减少这一数量。设置此阈值的一个准则是使用最小cell群，并留下一些dropout 效应（dropout effects. ）的余地。例如，筛选出少于 20 个细胞中表达的基因可能会使检测少于 20 个细胞的细胞团变得困难。对于高脱落（dropout ）率的数据集，这个阈值也可能使较大簇的检测复杂化。**阈值的选择应根据数据集中的细胞数量和预期的下游分析进行调整。**

&emsp;&emsp;可直接对计数数据进行进一步 QC。Ambient gene expression（环境基因表达）指不是来自barcode细胞，而是来自其他溶解细胞的count，这些细胞的 mRNA 在文库构建之前污染了细胞悬液。这些增加的环境计数会扭曲下游分析，如标记基因鉴定或其他差异表达检测，尤其是当样本之间的水平变化时。在基于液滴的 scRNA-seq 数据集中校正这些影响是可能的，由于大量的空液滴，可用于模拟环境RNA表达谱。最近开发的SoupX(预印本:Young &使用这种方法直接纠正计数数据。在下游分析中忽视强环境基因的实用方法也被用来解决这个问题(Ange- lidis et al, 2019)。

&emsp;&emsp;进行质量控制以确保数据质量足以用于下游分析。由于无法先验确定足够的数据质量，因此根据下游分析性能（例如，聚类注释）进行判断。在分析数据时，可能需要多次重新审查质量控制参数。通常，从允许的质控阈值开始，在执行更严格的质控之前研究这些阈值的影响是有益的。这种方法对于包含异质性细胞群的数据集特别重要，其中细胞类型或状态可能被错误解释为低质量离群细胞。在低质量数据集中，严格的 QC 阈值可能是必要的。可通过试验 QC 指标确定数据集的质量（见附录补充文本 S2，卑微小王手头并没有补充文档，从略）。在这种迭代 QC 优化中，应该注意数据窥视（data peeking.）。不应调整 QC 阈值以改善统计检验的结果。相反，可根据数据集可视化和聚类中的 QC 变量分布来评价 QC效用。

>问题和建议:
>
>通过基因数量、计数深度和线粒体reads分数的异常峰来执行细胞QC。考虑这些共同的影响而不是单独的考虑它们。
>
>尽可能地容忍QC阈值化，如果下游聚类无法解释，则重新QC。
>
如果QC变量在样品之间的分布不同，则应针对每个样品分别QC，以解释样品质量差异，如Plasschaert等(2018)。

---

### 2.Normalization

&emsp;&emsp;计数矩阵中的每个计数代表细胞 mRNA 分子的成功捕获、逆转录和测序（框 1）。由于每个步骤固有的变异性，相同细胞的计数深度结果却可能不同。因此，当基于计数数据比较细胞间的基因表达时，任何差异可能仅由采样效应（ sampling effects.）引起。通过例如缩放（ sampling effects）计数数据以获得正确的细胞间相对基因表达丰度来解决这一问题。

&emsp;&emsp;bulk RNA数据已有许多标准化方法 (preprint:Pachter,2011;Dillies et al,2013)。虽然其中一些方法已应用于 scRNA-seq 分析，但单细胞数据特有的变异来源如技术脱落（technical dropouts ）（取样导致的零计数，双零问题）促使开发出了针对 scRNA-seq 的标准化方法 (Lun et al,2016a；Vallejos et al,2017)。

&emsp;&emsp;最常用的规范化协议是 count depth scaling，也称为每百万计数或 CPM 规范化。该方案来自bulk 表达分析，并使用与每个细胞计数深度成比例的所谓大小因子对计数数据进行标准化。该方法的变体使用不同的因子或数据集中每个细胞的中位计数深度缩放。CPM 标准化假设数据集中的所有细胞最初包含相同数量的 mRNA 分子，计数深度差异仅由于取样产生。该假设与下采样（downsampling）方案相同，下采样方案是从数据中随机取样读取或计数，使所有细胞的计数预先规定的数量或更少。在下采样丢掉数据的同时，也增加了技术脱落率，而 CPM 和其他全局缩放标准化方法则没有。因此，下采样可以提供类似计数深度下细胞表达谱的更真实表示。

&emsp;&emsp;由于单细胞数据集通常由具有不同大小和分子计数的异质细胞群组成，因此更复杂的标准化方法通常是合适的。例如，Weinreb et al (2018) 使用了 CPM 的简单延伸，计算它们的大小因子时，排除了任何细胞中占总计数至少 5% 的基因。这种方法考虑到了少数高表达基因的分子计数变异性。基于 Scran 合并的尺寸因素估计（pooling-based size factor estimation）方法允许更多的细胞异质性 (Lun et al,2016a)。细胞合并后，根据基因的线性回归估算大小因子，以避免技术脱落效应。该方法将变异性限制在细胞间差异表达基因的 50% 以下，并且在独立比较中始终是性能最佳的标准化方法。经证明，Scran 在批次校正（ batch correction） (Buttner et al,2019) 和差异表达分析 (preprint：vith et al,2019) 方面的性能优于其他检测的归一化方法。在与原作者的小规模比较中，该方法也显示出稳健的尺寸因子估计值 (Vallejos et al,2017)。

&emsp;&emsp;CPM、高计数过滤 CPM 和 scran 使用线性、全局缩放标准化计数数据。还存在非线性归一化方法，可解释更复杂的异质性(Cole et al,2019)。许多方法涉及到计数资料的参数化建模。例如，Mayer et al (2018) 使用技术变量（如测序深度和每个基因的计数数量）拟合负二项模型，以拟合模型参数。模型拟合的残差作为基因表达的标准化定量。这种方法可以将技术和生物数据校正（例如批次校正或细胞周期效应校正）与计数深度归一化相结合。已证明非线性归一化方法优于全局缩放方法，尤其是在具有强批次效应的情况下 (Cole et al,2019)。因此，非线性归一化方法对于基于平板的 scRNA-seq 数据尤其相关，这些数据往往在平板之间存在批次效应。此外，与基于液滴的数据相比，基于平板的数据可显示每个细胞计数深度的较大变化 (Svensson et al,2017)。虽然非线性归一化方法或替代方法（例如下采样）似乎更适合这些条件，但需要进行比较研究来确认该假设。在本教程中，我们倾向于将标准化和数据校正（批次校正、噪声校正等）步骤分开，以强调数据的不同处理阶段（参见预处理数据部分的阶段）。因此，我们着重研究全局尺度归一化方法（global scaling normalization）。

&emsp;&emsp;我们不能期望单一的标准化方法适合所有类型的 scRNA-seq 数据。例如，vith et al (2017) 表明reads和计数数据可通过不同模型进行最佳拟合。事实上，Cole et al (2019) 发现没有一种归一化方法对不同的数据集表现都是最佳的，并认为应使用其 scone 工具为特定数据集选择适当的归一化方法。此外，scRNA-seq 技术可分为全长和 30 种富集方法 (Svensson et al,2017；Ziegenhain et al,2017)。来自全长方案的数据可能受益于考虑到基因长度的标准化方法（例如 Patel et al,2014；Kowalczyk et al,2015；Soneson）

&emsp;&emsp;细胞计数数据可以归一化，使细胞间具有可比性，同样，基因计数也可以按比例调整，以改善基因间的比较。基因归一化构成基因计数的标度，使其均值和单位变异(z值)为零。这种比例的变化影响了所有的基因下游分析的权重。是否对基因进行归一化目前尚无共识。虽然流行的Seurat教程(Butler et al, 2018)通常应用基因缩放（scaling,），但Slingshot方法的作者在他们的教程中选择不缩放基因(Street et al, 2018)。这两种选择之间的偏好围绕着是否所有的基因都应该在下游分析中得到同等的权重，或者一个基因的表达量是否代表了该基因的重要性。为了尽可能多地保留数据中的生物信息，我们选择在本教程中避免对基因进行筛选。

归一化后，数据矩阵通常是对数 (+ 1) 转换的。这种转变有三个重要作用。

- 首先，对数转换的表达值之间的距离代表对数倍数变化，这是衡量表达变化的经典方式。
- 其次，对数转换减轻（但不消除）单细胞数据中的均值方差关系 (Brennecke et al,2013)。
- 最后，对数转换降低了数据的偏斜度，以适用于假设数据呈正态分布的下游分析工具。

&emsp;&emsp;虽然 scRNA-seq 数据实际上不是对数正态分布 (Vieth et al,2017)，但这三种效应使对数转换成为一种粗糙但有用的工具。差异表达检测 (Finak et al,2015；Ritchie et al,2015) 或批次校正 (Johnson et al,2006；Buttner et al,2019) 的下游应用强调了这种有用性，这些应用将对数转换用于这些目的。但是，应该注意的是，归一化数据的对数转换可在数据中引入虚假差异表达效应（预印：Lun，2018）。当归一化大小因子分布在试验组之间存在强烈差异时，该效应尤其明显。

>问题和建议:
>
>我们建议使用scran对非全长数据集进行标准化。
>
>另一种方法是通过scone评估基于平台的数据集的标准化方法。全长scRNA-seq协议可以使用bulk 方法修正基因长度。
>
>对于将基因的均值和单位方差缩放到0没有共识。
>
>我们宁愿不缩放基因表达（We prefer not to scale gene expression.）。
>
>规范化的数据应该是log(x+1)-转换后用于假设数据是正态分布的下游分析方法。

---