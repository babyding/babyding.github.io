---
layout:     post
title:      2020-06-08-单细胞测序系列文章三
subtitle:   单细胞转录组数据处理之上游分析流程
date:       2020-06-08
author:     DL
header-img: img/home-bg-o.jpg
catalog: true
tags:
    - 单细胞测序
---

> 来源：[单细胞天地](https://mp.weixin.qq.com/s/-h2Qr7oVN93Z0JlVOO4uZA)


### 一、前言

scRNA-seq技术到目前为止也有一百多个了，但主流的可以大致分为以下几种：

- Droplet-based: **10X Genomics**, inDrop, Drop-seq

- Plate-based with unique molecular identifiers (UMIs): CEL-seq, MARS-seq

- Plate-based with reads: **Smart-seq2**

- Other: sci-RNA-seq, Seq-Well

实际上我们需要理解的就是10x数据和Smart-seq2技术啦，最常用而且最常见！

---

### 二、10X Genomics的原始数据

目前单细胞是10x的天下，而10x的测序数据，御用软件cellranger其实就是star的包装，关于10X仪器的单细胞转录组数据走cellranger流程，教程如下：

- [单细胞实战(一)数据下载](https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&mid=2247484146&idx=1&sn=16e09b82d048eed1ff6100b22970abd5&scene=21#wechat_redirect)

- [单细胞实战(二) cell ranger使用前注意事项](https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&mid=2247484179&idx=1&sn=fe84f5243a6021fe6afea128e3ac273a&scene=21#wechat_redirect)

- [单细胞实战(三) Cell Ranger使用初探](https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&mid=2247484206&idx=1&sn=edeebbdd092f79361aee87e9ce086d80&scene=21#wechat_redirect)

- [单细胞实战(四) Cell Ranger流程概览](https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&mid=2247484355&idx=1&sn=7860fe0c46073a55d2d3700822c3103b&scene=21#wechat_redirect)

- [单细胞实战(五) 理解cellranger count的结果](https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&mid=2247484402&idx=1&sn=95c2be0dc6499e4b1eb9a91d79e584d1&scene=21#wechat_redirect)

输入数据是测序序列的fastq文件，输出的是表达矩阵。值得注意的是，每个10x样本都有3个fastq文件作为输入，然后输出的表达矩阵，也是3个文件。

在教程：[使用seurat3的merge功能整合8个10X单细胞转录组样本](https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&mid=2247485216&idx=1&sn=ad88d057acfc5e0fefd5ab69ffb46ee8&scene=21#wechat_redirect)和[seurat3的merge功能和cellranger的aggr整合多个10X单细胞转录组对比](https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&mid=2247485224&idx=1&sn=e8adfcc8d6faa95837c65bce4509dc43&scene=21#wechat_redirect)，也给出了后续R代码读取10x单细胞转录组数据的3个文件的表达矩阵。

---

### 三、10X Genomics的单细胞公共数据

比如 GSE128033 和 GSE135893，就是10x数据集，随便下载其中一个，就能看到每个样本都是走流程拿到10x单细胞转录组数据的3个文件的表达矩阵。

```
2.2M Mar  8  2019 GSM3660655_SC94IPFUP_barcodes.tsv.gz
259K Mar  8  2019 GSM3660655_SC94IPFUP_genes.tsv.gz
 26M Mar  8  2019 GSM3660655_SC94IPFUP_matrix.mtx.gz
2.2M Mar  8  2019 GSM3660656_SC95IPFLOW_barcodes.tsv.gz
259K Mar  8  2019 GSM3660656_SC95IPFLOW_genes.tsv.gz
 31M Mar  8  2019 GSM3660656_SC95IPFLOW_matrix.mtx.gz
2.2M Mar  8  2019 GSM3660657_SC153IPFLOW_barcodes.tsv.gz
259K Mar  8  2019 GSM3660657_SC153IPFLOW_genes.tsv.gz
 33M Mar  8  2019 GSM3660657_SC153IPFLOW_matrix.mtx.gz
2.2M Mar  8  2019 GSM3660658_SC154IPFUP_barcodes.tsv.gz
259K Mar  8  2019 GSM3660658_SC154IPFUP_genes.tsv.gz
 31M Mar  8  2019 GSM3660658_SC154IPFUP_matrix.mtx.gz
```

下游处理的时候，一定要保证这3个文件同时存在，而且在同一个文件夹下面。

示例代码是：

```
rm(list=ls())
options(stringsAsFactors = F)
library(Seurat)
sce1 <- CreateSeuratObject(Read10X('../10x-results/WT/'),
                          "wt")
```

重点就是 Read10X 函数读取 文件夹路径，比如：../10x-results/WT/ ，保证文件夹下面有3个文件。

---

### 四、Smart-seq2数据

这个其实就是普通的转录组数据处理流程哦，比如我们看2017-scRNA-seq-primary breast cancer，韩国研究团队是这样描述的：

[![DJ2wKf.jpg](https://s3.ax1x.com/2020/11/23/DJ2wKf.jpg)](https://imgchr.com/i/DJ2wKf)

其实Smart-seq2单细胞最出名的应该是北京大学张泽民教授团队的多种癌症免疫浸润T细胞测序，包括肝癌，结直肠癌，肺癌的，比如 https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE98638

[![DJ2Rx0.png](https://s3.ax1x.com/2020/11/23/DJ2Rx0.png)](https://imgchr.com/i/DJ2Rx0)

这样的表达矩阵，每个样本只有一个文件即可，需要注意的是，提供多种多样数据格式，需要自行阅读量过两万的综述翻译及其细节知识点的补充：

- [RNA-seq的counts值，RPM, RPKM, FPKM, TPM 的异同](https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&mid=2247490699&idx=2&sn=6d7e0d96779d4885f3c36089cdd31516&scene=21#wechat_redirect)

- [RNAseq数据，下载GEO中的FPKM文件后该怎么下游分析](https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&mid=2247492196&idx=1&sn=1bcdef5e19cdde2b0d8cc947c759fac6&scene=21#wechat_redirect)

上游分析对大家来说比较困难，除非你有Linux基础，代码如下：

```
hisat2=/home/jianmingzeng/biosoft/HISAT/hisat2-2.0.4/hisat2
# # 如果使用conda安装的 hisat2，那么 hisat2 命令应该是在环境变量的。
## 索引文件需要自己下载
# https://ccb.jhu.edu/software/hisat2/manual.shtml
# wget ftp://ftp.ccb.jhu.edu/pub/infphilo/hisat2/data/mm10.tar.gz

index=/home/jianmingzeng/reference/index/hisat/mm10/genome
ls raw_fq/*gz |  while read id; do
$hisat2 -p 10 -x $index -U $id  -S ${id%%.*}.hisat.sam
done

ls *.sam|while read id ;do (samtools sort -O bam -@ 5  -o $(basename ${id} ".sam").bam   ${id});done
rm *.sam
ls *.bam |xargs -i samtools index {}

## gtf文件推荐去gencode数据库下载
gtf=/home/jianmingzeng/reference/gtf/gencode/gencode.vM12.annotation.gtf
featureCounts=/home/jianmingzeng/biosoft/featureCounts/subread-1.5.3-Linux-x86_64/bin/featureCounts   
# # # 如果使用conda安装的 subread，那么featureCounts  命令应该是在环境变量的。
$featureCounts -T 5 -p -t exon -g gene_id  -a $gtf -o  all.id.txt  *.bam  1>counts.id.log 2>&1 &
 # 得到的就是 count矩阵
```

大家可能会觉得奇怪，为什么我给到的代码里面的软件，都不是截图文献里面使用的呢？其实转录组数据处理流派太多了，并没有绝对的权威。

同样的，很大概率你不需要自己处理上游数据，而是公共数据库，比如我通常是下载上面的count矩阵，然后走代码：

```
rm(list=ls())
options(stringsAsFactors = F)
# install.packages('R.utils')
# install.packages('data.table')
library(data.table)
# 这个表达矩阵其实是10x的，不过可以演示
a=fread('GSE117988_raw.expMatrix_PBMC.csv.gz',header = TRUE)
length(a$V1)
length(unique(a$V1))
hg=a$V1
dat=a[,2:ncol(a)]
rownames(dat)=hg
hg[grepl('^MT-',hg)]
colnames(dat)
rownames(dat)
meta=as.data.frame(colnames(dat))
colnames(meta)=c('cell name')
rownames(meta)=colnames(dat)
head(meta)
## 前面大量的代码，都是数据预处理
library(Seurat)
dat[1:4,1:4]
class(dat)
# 重点是构建 Seurat对象
pbmc  <- CreateSeuratObject(counts = dat,
                            meta.data = meta,
                            min.cells = 3, min.features = 200,project = '10x_PBMC')

pbmc
head(colnames(dat))
head(rownames(dat))  
rownames(GetAssayData(pbmc,'counts'))
pbmc[["percent.mt"]] <- PercentageFeatureSet(pbmc, pattern = "^MT-")
```

两种单细胞转录组数据，都是走Seurat流程，只不过是构建 Seurat对象的代码不一样，注意仔细分辨！

---

### 五、Q&A

#### 5.1 很大概率上你并不会需要自己走上游流程

主要是因为对计算资源的消耗，实验室搭建上游流程成本太高，还不如一次性付费让公司做出来表达矩阵给到你后下游慢慢探索。但是懂上游分析流程有助于你更好的认识你的单细胞数据！


#### 5.2 为什么10x单细胞转录组表达矩阵有3个文件

因为10x单细胞转录组表达矩阵里面的0值非常多，所以换成3个文件存储更节省空间。本质上仍然是一个表达矩阵而已，如果你都有了表达矩阵，就没必要去想那3个文件了。
